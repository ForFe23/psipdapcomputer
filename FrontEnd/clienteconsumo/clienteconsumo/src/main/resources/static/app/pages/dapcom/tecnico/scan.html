<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Escanear</title>
  <link rel="icon" href="/assets/images/qafya-icon.ico">
  <link rel="stylesheet" href="/assets/css/vendors/bootstrap.min.css">
  <link rel="stylesheet" href="/assets/css/vendors/line-awesome.min.css">
  <link rel="stylesheet" href="/assets/css/pages/layout.css">
</head>
<body class="dark-portal">
  <div class="card-shell">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h5 class="mb-0 text-white">Escanear código</h5>
        <small class="text-muted">Enfoca el QR del equipo</small>
      </div>
      <a class="btn btn-link text-light" href="menu.html">Volver</a>
    </div>
    <div id="videoWrapper" class="mb-3">
      <video id="video" autoplay playsinline muted style="width:100%;height:auto;"></video>
      <canvas id="canvas" class="d-none"></canvas>
      <div id="overlay"></div>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-ghost w-100" id="btnSwitch"><i class="las la-sync mr-1"></i>Cambiar cámara</button>
      <button class="btn btn-main w-100" id="btnFlash"><i class="las la-bolt mr-1"></i>Flash</button>
    </div>
    <div class="alert alert-warning mt-3 d-none" id="msg"></div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.3.1/dist/jsQR.min.js"></script>
  <script type="module">
    import { enforceRole, getAccessScope } from "../../../js/auth.js";
    const session = enforceRole(["TECNICO_GLOBAL", "TECNICO_CLIENTE"]);
    const scope = getAccessScope();
    const buildUrl = (serie) => {
      const params = new URLSearchParams();
      params.set("serie", serie);
      if (scope.clienteId) params.set("clienteId", scope.clienteId);
      if (scope.empresaId) params.set("empresaId", scope.empresaId);
      return `detalle.html?${params.toString()}`;
    };
    const msg = document.getElementById("msg");
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    let currentFacing = "environment";
    let stream;
    let scanning = false;
    let torchAvailable = false;


    if (!window.isSecureContext && location.hostname !== "localhost" && location.hostname !== "127.0.0.1") {
      showMsg("Para usar la cámara desde otro dispositivo, expón el front por https (ngrok/localhost.run) o usa localhost.");
    }
    const start = async () => {
      if (stream) stream.getTracks().forEach(t => t.stop());
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: currentFacing } } });
        video.srcObject = stream;
        const track = stream.getVideoTracks()[0];
        const caps = track.getCapabilities ? track.getCapabilities() : {};
        torchAvailable = !!caps.torch;
        document.getElementById("btnFlash").disabled = !torchAvailable;
        video.onloadedmetadata = () => {
          canvas.width = video.videoWidth || 640;
          canvas.height = video.videoHeight || 480;
          scanning = true;
          requestAnimationFrame(tick);
        };
      } catch (err) {
        showMsg("No se pudo acceder a la cámara: " + err.message);
      }
    };
    const tick = () => {
      if (!scanning) return;
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });
        if (code && code.data) {
          scanning = false;
          flashOverlay();
          const serie = code.data.trim();
          setTimeout(() => (window.location.href = buildUrl(serie)), 120);
          return;
        }
      }
      requestAnimationFrame(tick);
    };
    document.getElementById("btnSwitch").addEventListener("click", () => {
      currentFacing = currentFacing === "environment" ? "user" : "environment";
      start();
    });
    document.getElementById("btnFlash").addEventListener("click", async () => {
      if (!stream || !torchAvailable) return;
      const track = stream.getVideoTracks()[0];
      const cur = track.getConstraints();
      const currentTorch = cur?.advanced?.find(c => c.torch)?.torch || false;
      await track.applyConstraints({ advanced: [{ torch: !currentTorch }] });
    });

    function flashOverlay() {
      const ov = document.getElementById("overlay");
      ov.classList.add("flash");
      setTimeout(() => ov.classList.remove("flash"), 180);
    }

    function showMsg(text) {
      msg.textContent = text || "";
      msg.classList.toggle("d-none", !text);
    }
    start();
  </script>
</body>
</html>


